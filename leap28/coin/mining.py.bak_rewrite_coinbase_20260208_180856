import hashlib
import time
from .tx_validation import compute_tx_id

def mine_block(miner_address, difficulty=18, max_attempts=10000):
    target = "0" * difficulty
    for nonce in range(max_attempts):
        data = f"{miner_address}{time.time()}{nonce}"
        hash_result = hashlib.sha256(data.encode()).hexdigest()
        if hash_result.startswith(target):
            return {"nonce": nonce, "hash": hash_result}
    return None
def build_coinbase_tx(
    miner_address: str,
    amount: int,
    *,
    nonce: int,
    height: int,
    timestamp: int | None = None,
    tag: str = "mining_reward",
) -> dict:
    """
    HARDENED: COINBASE_REQUIRES_MINER_NONCE_V1

    STRICT coinbase tx builder.
    Must satisfy tx_validation.is_coinbase_tx strict identity + STRICT_COINBASE_FIELDS_V3:
      - sender == "COINBASE"
      - type == "coinbase"
      - coinbase == True
      - miner present AND receiver == miner
      - nonce present (int)

    NOTE: PoW verification is not done here; this is a deterministic tx envelope.
    """
    ts = int(timestamp) if timestamp is not None else int(time.time())
    amt = int(amount)
    if amt <= 0:
        raise ValueError("reward must be positive")
    n = int(nonce)
    miner = str(miner_address)
    if miner.strip() == "":
        raise ValueError("miner_address must be non-empty")

    # HARDENED: BUILD_COINBASE_FIELDS_V2
    tx = {
        "type": "coinbase",
        "coinbase": True,
        "sender": "COINBASE",
        "receiver": miner,
        # HARDENED: COINBASE_BUILDER_FIELDS_V3

        "height": int(height),
        "miner": miner,
        "nonce": n,
        "amount": amt,
        "timestamp": ts,
        "tag": str(tag),
        # Signature is a sentinel; validators may skip signature gate for strict coinbase.
        "signature": "COINBASE_WIP",
    }
    tx["id"] = compute_tx_id(tx)
    return tx
def build_mint_tx(
    to_address: str,
    amount: int,
    *,
    nonce: int,
    timestamp: int | None = None,
    memo: str = "mint",
) -> dict:
    """Alias of strict coinbase semantics (issuance path). HARDENED: COINBASE_REQUIRES_MINER_NONCE_V1"""
    return build_coinbase_tx(to_address, int(amount), nonce=int(nonce), timestamp=timestamp, tag=memo)
